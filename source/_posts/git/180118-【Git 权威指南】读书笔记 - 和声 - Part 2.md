---
title: 【Git 权威指南】读书笔记 - 和声 - Part 2
permalink: got-git-reading-notes-harmony-part2
date: 2018-01-18 19:00:00
updatetime: 2018-01-19 14:00:00
comments: true
toc: true
tags:
   - git
description:
---

主要内容：【Git 分支】、【远程版本库】、【补丁文件交互】

## Git 分支

分支是代码管理的利器。如果没有有效的分支管理，代码管理就适应不了复杂的开发过程和项目的需要。

### 分支命令概述

```
# 显示
1. git branch

# 创建
2. git branch <branchname>
3. git branch <branchname> <start-point>

# 删除，-d 在删除分支 <branchname> 时会检查所要删除的分支是否已经合并到其他分支中，否则拒绝删除。
4. git branch -d <branchname>
5. git branch -D <branchname>

# 重命名，-m 如果版本库中已经存在名为 <newbranch> 的分支，拒绝执行重命名，而 7 会强制执行。
6. git branch -m <oldbranch> <newbranch>
7. git branch -M <oldbranch> <newbranch>
```

<!-- more -->

创建并切换到新分支：

```
git checkout -b <new_branch> [<start_point>]
```

### 分支变基

- master
- dev（开发完成，领先 master）

```
# 先切换到 dev
$ git checkout dev

# 变基操作
$ git rebase master

# 遇到冲突，解决冲突

# 添加到暂存区
$ git add -u

# 继续变基
$ git rebase --continue

# 直接将 dev 推送到远程 master
$ git push origin dev:master

# 切换到 master
$ git checkout master

# 拉取最新代码
$ git pull

# 删除 dev 分支
$ git branch -d dev
```

## 远程版本库

### 远程分支

查看远程分支：

```
$ git branch -r
```

在向远程版本库执行获取操作时，不是把远程版本库的分支原封不动地复制到本地版本库的分支中，而是复制到另外的命名空间。

远程分支不是真正意义上的分支，是类似于里程碑一样的引用。如果针对远程分支执行检出命令，会看到大段的错误警告。

远程分支类似于里程碑，如果检出就会使得头指针 HEAD 处于分离头指针状态。实际上除了以 refs/heads 为前缀的引用之外，如果检出任何其他引用，都将使工作区处于分离头指针状态。如果对远程分支进行修改就需要创建新的本地分支。

### 分支追踪

为了能够在远程分支 `origin/hello-1.x` 上进行工作，需要基于该远程分支创建本地分支：

```
$ git checkout hello-1.x
```

从远程分支创建本地分支，自动建立了分支间的跟踪，而从一个本地分支创建另外一个本地分支则没有。

从 `hello-1.x` 分支中创建新的本地分支 `hello-jx`，并与远程建立联系。

```
$ git checkout -b hello-jx hello-1.x
```

```
cat .
```

### 远程版本库

```
# 设置
$ git remote add new-remote file:///path/to/repos/hello-user1.git

# 修改 url
$ git remote set-url new-remote file:///path/to/repos/hello-user2.git

# 单独修改 push 地址
$ git remote set-url --push new-remote /path/to/repos/hello-user2.git

# 修改 版本库名称
$ git remote rename new-remote user2

# 当注册了多个远程版本库并希望获取所有远程版本库的更新
$ git remote update

# 如果某个远程版本库不想在执行 git remote update 时获得更新
$ git config remote.user2.skipDefaultUpdate true

# 删除
$ git remote rm
```

### PUSH 和 PULL 操作与远程版本库

在执行 `git pull` 操作的时候可以通过参数 `--rebase` 设置使用变基而非合并操作，将本地分支的改动变基到跟踪分支上。为了避免因为忘记使用 `--rebase` 参数导致分支的合并，可进行设置：

```
$ git config branch.<branchname>.rebase true
```

这样在遇到冲突（本地和远程分支出现偏离）的情况下，会采用变基操作，而不是默认的合并操作。

如果为本地版本库设置参数 `branch.autosetuprebase` ，值为 `true`，则在基于远程分支建立本地追踪分支时，会自动配置 `branch.<branchname>.rebase` 参数。

### 分支和里程碑的安全性

- 用 `reflog` 记录对分支的操作历史。默认创建的带工作区的版本库都会包含 `core.logallrefupdates` 为 `true` 的配置，这样在版本库中建立的每个分支都会创建对应的 `reflog`。但是创建的裸版本库默认不包含这个设置，也就不会为每个分支设置 `reflog`。可能因为分支误操作导致数据丢失，可以考虑为裸版本库添加此配置。

- 关闭非快进式提交。配置 `receive.denyNonFastForwards` 设置为 `true`，则禁止一切非快进式推送。更好的方法是通过架设基于 SSH 协议的 Git 服务器，配置强制提交的用户权限。

- 关闭分支删除功能。配置 `receive.denyDeletes` 设置为 `true`，则禁止删除分支。更好的方法是：配置分支删除的用户权限。

## 补丁文件交互

将最近三个提交转换为补丁文件：

```
$ git format-patch -s HEAD~3..HEAD
```

`-s` 会在导出的补丁文件中添加当前用户的签名。

应用补丁：

```
$ git am user1-mail-archive
```

`git apply` 可以应用一般格式的补丁文件，但是不能执行提交，也不能保持补丁中的作者信息。

> Reference:
> - [3. Git和声 &mdash; GotGit](http://www.worldhello.net/gotgit/03-git-harmony)
